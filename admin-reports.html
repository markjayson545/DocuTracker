<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Reports | DocuTrack</title>
    
    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- JavaScript Files -->
    <script src="js/services/handle-user-notification.js"></script>
    <script src="js/services/check-session.js"></script>
    <script src="js/services/open-user-menu.js"></script>
    <script src="js/services/sidebar.js"></script>
    <script src="js/services/logout.js"></script>
    <script src="js/admin/search-handler.js"></script>
    
    <!-- Global CSS First -->
    <link rel="stylesheet" href="css/global/master.css">
    <!-- Then Page-specific CSS -->
    <link rel="stylesheet" href="css/admin-dashboard.css">
    <link rel="stylesheet" href="css/admin-reports.css">
    <link rel="stylesheet" href="css/admin-reports-button.css">

    <!-- External Libraries -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
        integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>

<body>
    <header>
        <a href="index.html">
            <h2>
                <i class="fas fa-file-invoice"></i> DocuTrack
            </h2>
        </a>
        <div class="search-container">
            <input type="search" placeholder="Search documents, requests..." aria-label="Search" id="search-input">
            <button title="submit" type="submit"><i class="fas fa-search"></i></button>
            <div class="search-results-dropdown" id="search-results-dropdown">
                <div class="search-results-header">
                    <h4>Search Results</h4>
                </div>
                <div class="search-results-list" id="search-results-list">
                    <!-- Templates for search results that will be shown/hidden by JS -->
                    <p id="search-message" class="search-message">Type at least 1 characters to search</p>

                    <!-- User result template -->
                    <div class="search-result-item template" id="user-result-template" data-type="user"
                        style="display: none;">
                        <i class="fas fa-user"></i>
                        <div class="search-result-details">
                            <p class="result-title" id="user-result-name">John Doe</p>
                            <p class="result-meta">User • <span id="user-result-email">example@email.com</span></p>
                        </div>
                    </div>

                    <!-- Request result template -->
                    <div class="search-result-item template" id="request-result-template" data-type="request"
                        style="display: none;">
                        <i class="fas fa-file-alt"></i>
                        <div class="search-result-details">
                            <p class="result-title">Document Request</p>
                            <p class="result-meta">Request • REQ-<span id="request-result-id">001</span> • <span
                                    id="request-result-status">Pending</span></p>
                        </div>
                    </div>

                    <!-- Application result template -->
                    <div class="search-result-item template" id="application-result-template" data-type="application"
                        style="display: none;">
                        <i class="fas fa-clipboard-list"></i>
                        <div class="search-result-details">
                            <p class="result-title">Application</p>
                            <p class="result-meta">Application • APP-<span id="application-result-id">001</span> • <span
                                    id="application-result-status">Pending</span></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="header-actions">
            <div class="notification">
                <button class="notification-button" id="notification-button" title="Notifications">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge" id="notification-badge-count">3</span>
                </button>
                <div class="notification-dropdown" id="notification-dropdown">
                    <div class="notification-header">
                        <h3>Notifications</h3>
                        <button class="mark-all-read" id="mark-all-read">Mark all as read</button>
                    </div>
                    <div class="notification-list" id="notification-list">
                        <!-- Notifications will be loaded here -->
                    </div>
                </div>
            </div>

            <div class="login-or-create" id="login-or-create">
                <div class="login-button">
                    <a href="sign-in.html"><i class="fas fa-sign-in-alt"></i> Login</a>
                </div>
                <div class="signup-button">
                    <a href="sign-up.html"><i class="fas fa-user-plus"></i> Sign Up</a>
                </div>
            </div>

            <div class="user-info" id="user-info">
                <div class="user-icon">
                    <i class="fas fa-user-circle"></i>
                </div>
                <div class="user-details">
                    <p class="user-name" id="user-name">John Doe</p>
                    <p class="user-email" id="user-email">example@email.com</p>
                </div>
                <div class="user-dropdown" id="user-dropdown">
                    <div class="user-info-dropdown">
                        <div class="user-icon">
                            <i class="fas fa-user-circle"></i>
                        </div>
                        <div class="user-details">
                            <p class="user-name">John Doe</p>
                            <p class="user-email">example@email.com</p>
                        </div>
                    </div>
                    <hr>
                    <button id="logout-button" class="logout-button">
                        <i class="fas fa-sign-out-alt"></i>
                        Logout
                    </button>
                </div>
                <button title="dropdown-button" id="dropdown-button" class="dropdown-button">
                    <i class="fa-solid fa-caret-down"></i>
                </button>
            </div>
        </div>
    </header>

    <main>
        <div class="sidebar">
            <button class="dashboard-button" id="sidebar-toggle">
                <i class="fas fa-solid fa-bars" id="toggle-icon"></i>
                <h3>
                    <i class="fa-solid fa-table-columns"></i> Dashboard
                </h3>
            </button>
            <ul id="sidebar-menu">
                <li>
                    <button class="admin-dashboard-home" id="admin-dashboard-home">
                        <i class="fas fa-home"></i> Admin Dashboard
                    </button>
                </li>
                <li>
                    <button class="admin-manage-applications-sidebar-btn" id="admin-manage-applications-sidebar-btn">
                        <i class="fas fa-envelope"></i> Manage Applications
                    </button>
                </li>
                <li>
                    <button class="admin-manage-requests-sidebar-btn" id="admin-manage-requests-sidebar-btn">
                        <i class="fas fa-credit-card"></i> Manage Requests
                    </button>
                </li>
                <li>
                    <button class="admin-manage-users-sidebar-btn" id="admin-manage-users-sidebar-btn">
                        <i class="fas fa-user-circle"></i> Manage Users
                    </button>
                </li>
                <li>
                    <button class="active admin-reports-btn" id="admin-reports-btn">
                        <i class="fas fa-chart-bar"></i> Reports & Statistics
                    </button>
                </li>
                <li>
                    <button class="admin-settings-sidebar-btn" id="admin-settings-sidebar-btn">
                        <i class="fas fa-cogs"></i> Settings
                    </button>
                </li>
            </ul>
        </div>

        <div class="dashboard-body">
            <div class="dashboard-title">
                <h3>
                    <i class="fas fa-chart-line"></i> Reports & Statistics
                </h3>
                <p>
                    <i class="fas fa-user-shield"></i> Welcome back, <span id="admin-username">Admin</span>
                </p>
            </div>

            <!-- Time Interval Selection -->
            <div class="time-interval-selector">
                <h4>Select Time Interval:</h4>
                <div class="time-buttons">
                    <button class="time-btn active" data-interval="month">Monthly</button>
                    <button class="time-btn" data-interval="week">Weekly</button>
                    <button class="time-btn" data-interval="day">Daily</button>
                </div>
            </div>

            <div class="charts-container">
                <!-- User Statistics Section -->
                <div class="charts-section">
                    <h2><i class="fas fa-users"></i> User Statistics</h2>
                    <div class="chart-row">
                        <div class="chart-card">
                            <h3>User Growth Over Time</h3>
                            <div class="chart-container">
                                <canvas id="userGrowthChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-card">
                            <h3>User Status Distribution</h3>
                            <div class="chart-container">
                                <canvas id="userStatusChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-card">
                            <h3>Verification Rate</h3>
                            <div class="chart-container">
                                <canvas id="verificationRateChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Document Request Metrics Section -->
                <div class="charts-section">
                    <h2><i class="fas fa-file-alt"></i> Document Request Metrics</h2>
                    <div class="chart-row">
                        <div class="chart-card">
                            <h3>Request Status Distribution</h3>
                            <div class="chart-container">
                                <canvas id="requestStatusChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-card">
                            <h3>Request Volume Over Time</h3>
                            <div class="chart-container">
                                <canvas id="requestVolumeChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-card">
                            <h3>Most Requested Document Types</h3>
                            <div class="chart-container">
                                <canvas id="requestedDocTypesChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Financial Analysis Section -->
                <div class="charts-section">
                    <h2><i class="fas fa-money-bill-wave"></i> Financial Analysis</h2>
                    <div class="chart-row">
                        <div class="chart-card">
                            <h3>Revenue by Document Type</h3>
                            <div class="chart-container">
                                <canvas id="revenueByDocTypeChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-card">
                            <h3>Payment Method Distribution</h3>
                            <div class="chart-container">
                                <canvas id="paymentMethodChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-card">
                            <h3>Revenue Trends</h3>
                            <div class="chart-container">
                                <canvas id="revenueTrendsChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Application Processing Section -->
                <div class="charts-section">
                    <h2><i class="fas fa-clipboard-list"></i> Application Processing</h2>
                    <div class="chart-row">
                        <div class="chart-card">
                            <h3>Application Status Distribution</h3>
                            <div class="chart-container">
                                <canvas id="applicationStatusChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-card">
                            <h3>Application Processing Time</h3>
                            <div class="chart-container">
                                <canvas id="applicationTimeChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="about-us">
            <h3><i class="fas fa-info-circle"></i> About Us</h3>
            <p>Providing secure and efficient document<br> processing services.</p>
            <div class="social-media">
                <div class="social-media-icons">
                    <a href="#" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
                    <a href="#" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
                    <a href="#" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
                </div>
            </div>
        </div>

        <div class="quick-links">
            <h3><i class="fas fa-link"></i> Quick Links</h3>
            <ul>
                <li><a href="terms"><i class="fas fa-file-contract"></i> Terms of Service</a></li>
                <li><a href="privacy-policy"><i class="fas fa-user-shield"></i> Privacy Policy</a></li>
            </ul>
        </div>

        <div class="contacts">
            <h3><i class="fas fa-address-book"></i> Contact Us</h3>
            <div class="email">
                <i class="fas fa-envelope"></i>
                <a href="mailto:example@email.com">example@email.com</a>
            </div>
            <div class="telephone">
                <i class="fas fa-phone-alt"></i>
                <a href="tel:+639123456789">+639123456789</a>
            </div>
        </div>
    </footer>

    <!-- Chart.js Implementation -->
    <script>
        // Global chart objects
        let charts = {};

        document.addEventListener('DOMContentLoaded', function() {
            let currentInterval = 'month';
            initCharts(currentInterval);
            setupIntervalButtons();
        });

        function setupIntervalButtons() {
            const timeButtons = document.querySelectorAll('.time-btn');
            timeButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Update active button
                    timeButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Get interval and reload charts
                    currentInterval = this.dataset.interval;
                    initCharts(currentInterval);
                });
            });
        }

        function initCharts(interval) {
            // User Statistics
            fetchUserGrowth(interval);
            fetchUserStatusDistribution();
            fetchVerificationRate();
            
            // Document Request Metrics
            fetchRequestStatusDistribution();
            fetchRequestVolume(interval);
            fetchMostRequestedDocuments();
            
            // Financial Analysis
            fetchRevenueByDocumentType();
            fetchPaymentMethodDistribution();
            fetchRevenueTrends(interval);
            
            // Application Processing
            fetchApplicationStatusDistribution();
            fetchApplicationProcessingTime();
        }

        // User Growth Over Time
        function fetchUserGrowth(interval) {
            fetchStatisticsData('userGrowth', interval)
                .then(data => {
                    if (data.success) {
                        renderUserGrowthChart(data.data, interval);
                    }
                })
                .catch(error => console.error('Error fetching user growth data:', error));
        }

        function renderUserGrowthChart(data, interval) {
            const ctx = document.getElementById('userGrowthChart').getContext('2d');
            
            // Clear previous chart if it exists
            if (charts.userGrowthChart) {
                charts.userGrowthChart.destroy();
            }
            
            // Format labels based on interval
            const labels = data.map(item => {
                if (interval === 'day') return formatDate(item.date);
                if (interval === 'week') return 'Week ' + item.week.slice(-2);
                return formatYearMonth(item.month);
            });
            
            charts.userGrowthChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'New Users',
                        data: data.map(item => item.count),
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 2,
                        tension: 0.2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        }

        // User Status Distribution
        function fetchUserStatusDistribution() {
            fetchStatisticsData('userStatusDistribution')
                .then(data => {
                    if (data.success) {
                        renderUserStatusChart(data.data);
                    }
                })
                .catch(error => console.error('Error fetching user status data:', error));
        }

        function renderUserStatusChart(data) {
            const ctx = document.getElementById('userStatusChart').getContext('2d');
            
            // Clear previous chart if it exists
            if (charts.userStatusChart) {
                charts.userStatusChart.destroy();
            }
            
            charts.userStatusChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: data.map(item => capitalizeFirstLetter(item.status)),
                    datasets: [{
                        data: data.map(item => item.count),
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(255, 99, 132, 0.7)',
                            'rgba(255, 206, 86, 0.7)',
                            'rgba(153, 102, 255, 0.7)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });
        }

        // Verification Rate
        function fetchVerificationRate() {
            fetchStatisticsData('verificationRate')
                .then(data => {
                    if (data.success) {
                        renderVerificationRateChart(data.data);
                    }
                })
                .catch(error => console.error('Error fetching verification rate data:', error));
        }

        function renderVerificationRateChart(data) {
            const ctx = document.getElementById('verificationRateChart').getContext('2d');
            
            // Clear previous chart if it exists
            if (charts.verificationRateChart) {
                charts.verificationRateChart.destroy();
            }
            
            charts.verificationRateChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Verified', 'Not Verified'],
                    datasets: [{
                        data: [data.verified, data.not_verified],
                        backgroundColor: [
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(255, 99, 132, 0.7)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });
        }

        // Request Status Distribution
        function fetchRequestStatusDistribution() {
            fetchStatisticsData('requestStatusDistribution')
                .then(data => {
                    if (data.success) {
                        renderRequestStatusChart(data.data);
                    }
                })
                .catch(error => console.error('Error fetching request status data:', error));
        }

        function renderRequestStatusChart(data) {
            const ctx = document.getElementById('requestStatusChart').getContext('2d');
            
            // Clear previous chart if it exists
            if (charts.requestStatusChart) {
                charts.requestStatusChart.destroy();
            }
            
            charts.requestStatusChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: data.map(item => capitalizeFirstLetter(item.status)),
                    datasets: [{
                        data: data.map(item => item.count),
                        backgroundColor: [
                            'rgba(255, 206, 86, 0.7)',
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(255, 99, 132, 0.7)',
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(153, 102, 255, 0.7)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });
        }

        // Request Volume Over Time
        function fetchRequestVolume(interval) {
            fetchStatisticsData('requestVolume', interval)
                .then(data => {
                    if (data.success) {
                        renderRequestVolumeChart(data.data, interval);
                    }
                })
                .catch(error => console.error('Error fetching request volume data:', error));
        }

        function renderRequestVolumeChart(data, interval) {
            const ctx = document.getElementById('requestVolumeChart').getContext('2d');
            
            // Clear previous chart if it exists
            if (charts.requestVolumeChart) {
                charts.requestVolumeChart.destroy();
            }
            
            // Format labels based on interval
            const labels = data.map(item => {
                if (interval === 'day') return formatDate(item.date);
                if (interval === 'week') return 'Week ' + item.week.slice(-2);
                return formatYearMonth(item.month);
            });
            
            charts.requestVolumeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Request Volume',
                        data: data.map(item => item.count),
                        backgroundColor: 'rgba(54, 162, 235, 0.7)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        }

        // Most Requested Document Types
        function fetchMostRequestedDocuments() {
            fetchStatisticsData('mostRequestedDocuments')
                .then(data => {
                    if (data.success) {
                        renderRequestedDocTypesChart(data.data);
                    }
                })
                .catch(error => console.error('Error fetching most requested documents data:', error));
        }

        function renderRequestedDocTypesChart(data) {
            const ctx = document.getElementById('requestedDocTypesChart').getContext('2d');
            
            // Clear previous chart if it exists
            if (charts.requestedDocTypesChart) {
                charts.requestedDocTypesChart.destroy();
            }
            
            charts.requestedDocTypesChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(item => item.document_type),
                    datasets: [{
                        label: 'Number of Requests',
                        data: data.map(item => item.count),
                        backgroundColor: 'rgba(153, 102, 255, 0.7)',
                        borderColor: 'rgba(153, 102, 255, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        }

        // Revenue by Document Type
        function fetchRevenueByDocumentType() {
            fetchStatisticsData('revenueByDocumentType')
                .then(data => {
                    if (data.success) {
                        renderRevenueByDocTypeChart(data.data);
                    }
                })
                .catch(error => console.error('Error fetching revenue by document type data:', error));
        }

        function renderRevenueByDocTypeChart(data) {
            const ctx = document.getElementById('revenueByDocTypeChart').getContext('2d');
            
            // Clear previous chart if it exists
            if (charts.revenueByDocTypeChart) {
                charts.revenueByDocTypeChart.destroy();
            }
            
            charts.revenueByDocTypeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(item => item.document_type),
                    datasets: [{
                        label: 'Revenue (₱)',
                        data: data.map(item => item.total_revenue),
                        backgroundColor: 'rgba(255, 159, 64, 0.7)',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Payment Method Distribution
        function fetchPaymentMethodDistribution() {
            fetchStatisticsData('paymentMethodDistribution')
                .then(data => {
                    if (data.success) {
                        renderPaymentMethodChart(data.data);
                    }
                })
                .catch(error => console.error('Error fetching payment method data:', error));
        }

        function renderPaymentMethodChart(data) {
            const ctx = document.getElementById('paymentMethodChart').getContext('2d');
            
            // Clear previous chart if it exists
            if (charts.paymentMethodChart) {
                charts.paymentMethodChart.destroy();
            }
            
            charts.paymentMethodChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.map(item => formatPaymentMethod(item.mode_of_payment)),
                    datasets: [{
                        data: data.map(item => item.count),
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(255, 99, 132, 0.7)',
                            'rgba(255, 206, 86, 0.7)',
                            'rgba(75, 192, 192, 0.7)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });
        }

        // Revenue Trends
        function fetchRevenueTrends(interval) {
            fetchStatisticsData('revenueTrends', interval)
                .then(data => {
                    if (data.success) {
                        renderRevenueTrendsChart(data.data, interval);
                    }
                })
                .catch(error => console.error('Error fetching revenue trends data:', error));
        }

        function renderRevenueTrendsChart(data, interval) {
            const ctx = document.getElementById('revenueTrendsChart').getContext('2d');
            
            // Clear previous chart if it exists
            if (charts.revenueTrendsChart) {
                charts.revenueTrendsChart.destroy();
            }
            
            // Format labels based on interval
            const labels = data.map(item => {
                if (interval === 'day') return formatDate(item.date);
                if (interval === 'week') return 'Week ' + item.week.slice(-2);
                return formatYearMonth(item.month);
            });
            
            charts.revenueTrendsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Revenue (₱)',
                        data: data.map(item => item.revenue),
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 2,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Application Status Distribution
        function fetchApplicationStatusDistribution() {
            fetchStatisticsData('applicationStatusDistribution')
                .then(data => {
                    if (data.success) {
                        renderApplicationStatusChart(data.data);
                    }
                })
                .catch(error => console.error('Error fetching application status data:', error));
        }

        function renderApplicationStatusChart(data) {
            const ctx = document.getElementById('applicationStatusChart').getContext('2d');
            
            // Clear previous chart if it exists
            if (charts.applicationStatusChart) {
                charts.applicationStatusChart.destroy();
            }
            
            charts.applicationStatusChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: data.map(item => capitalizeFirstLetter(item.status)),
                    datasets: [{
                        data: data.map(item => item.count),
                        backgroundColor: [
                            'rgba(255, 206, 86, 0.7)',
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(255, 99, 132, 0.7)',
                            'rgba(54, 162, 235, 0.7)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });
        }

        // Application Processing Time
        function fetchApplicationProcessingTime() {
            fetchStatisticsData('applicationProcessingTime')
                .then(data => {
                    if (data.success) {
                        renderApplicationTimeChart(data.data);
                    }
                })
                .catch(error => console.error('Error fetching application processing time data:', error));
        }

        function renderApplicationTimeChart(data) {
            const ctx = document.getElementById('applicationTimeChart').getContext('2d');
            
            // Clear previous chart if it exists
            if (charts.applicationTimeChart) {
                charts.applicationTimeChart.destroy();
            }
            
            const processingHours = data.details.map(item => parseInt(item.processing_hours));
            
            // Create histogram data
            const maxHours = Math.max(...processingHours);
            const binSize = Math.ceil(maxHours / 10); // Create 10 bins
            const bins = Array(10).fill(0);
            
            processingHours.forEach(hours => {
                const binIndex = Math.min(Math.floor(hours / binSize), 9);
                bins[binIndex]++;
            });
            
            const binLabels = bins.map((_, i) => 
                `${i * binSize}-${(i + 1) * binSize} hours`
            );
            
            charts.applicationTimeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: binLabels,
                    datasets: [{
                        label: 'Number of Applications',
                        data: bins,
                        backgroundColor: 'rgba(75, 192, 192, 0.7)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                footer: () => {
                                    return `Average processing time: ${data.average_hours.toFixed(2)} hours`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Helper function to fetch data from the server
        function fetchStatisticsData(action, interval = null) {
            const formData = new FormData();
            formData.append('action', action);
            if (interval) {
                formData.append('interval', interval);
            }
            
            return fetch('php/services/handle-statistics.php', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            });
        }

        // Helper functions for formatting
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function formatYearMonth(yearMonth) {
            const [year, month] = yearMonth.split('-');
            const date = new Date(year, month - 1);
            return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
        }

        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }

        function formatPaymentMethod(method) {
            switch (method.toLowerCase()) {
                case 'credit-card':
                    return 'Credit Card';
                case 'gcash':
                    return 'GCash';
                default:
                    return method.split('-').map(capitalizeFirstLetter).join(' ');
            }
        }
    </script>
</body>

</html>
